# LeonardoTaiko

A basic and easy to use e-box with Arduino Leonardo/ProMicro.   

![Yawaraka Tank](https://raw.githubusercontent.com/judjdigj/LeonardoTaiko/main/pics/result.jpg)  
Yawaraka Tank Ura

## Feature

* Written in Arduino IDE.
* Nintendo Switch Support
* Easy to build.

## Hardware Parts
* Arduino Leonardo/Pro Micro  
* Piezo sensor x4  
* 1MOhm resistor x4  
* Bread borad and wires(you can print your own pcb if you want)  
![board](https://raw.githubusercontent.com/judjdigj/LeonardoTaiko/main/pics/wiring.png)  

Circuit pics from [ArduinoTaikoController](https://github.com/LuiCat/ArduinoTaikoController).

Note:
Piezo sensor will generate ositive and negative voltage when working, so positive/negative to GND probably doesn't matter. However I'm not sure if negative voltage will cause any damage to ADC on Arduino Leonardo. If that concern you, you can use diodes or diode bridges to fix this issue.  

## Algorithm
### To Avoid Mistaken Input
Once a analog value is higher the ```threshold```, a input will be detected. 

We all know AC Taiko was built with 4 parts: left rim, left surface, right surface, right rim.
![Taiko](https://raw.githubusercontent.com/judjdigj/LeonardoTaiko/develop/pics/TaikoStructure.jpg)

However, unlike electronic drum set, where each piezo sensors are seperated, there will always be some connection between each part of the Taiko drum, no matter the base wooden plate or the rubber surface. So when you hit one part, the other 3 parts will also be vibrated, causing all the sensors delivering signals.

If the noise signal from the other parts was detected before the actual part that got hit, a mistaken input will happen.

To prevent mistaken input, it will start storage all the analog input into buffer for a short period. Since the noise analog value on other sensor should be smaller than the one which actual got hit, comparing each value in buffer, the largest value should be generated by the actual sensor got hit.

So after some calculation, you should get the right sensor got hit.

Then convert it into HID keyboard or controller.

You can also imply some smoothing filter to preprocessing the raw analog input signal. In my case, the sensors are good enough.

In order to shorten the buffer loop and key pressing time for better latency and faster response, I also imported dynamite threshold.

### Double Input (Big Notes)

This algorithm doesn't support double input (you need that to hit big notes on console version of Taiko no Tatsujin for a higher score). However technically you can do some key mapping trick to make one hit equal to 2 key pressed.

## Parameters Explain:

### ```threshold```

The value to trigger a input. The lower it was set, the more sensitive the drum will get. If it's lower than the idle noises which piezo sensor will definitely generated, random input will occur.

### ```outputDuration```
When an input is triggered, a key will be pressed. This parameter decide how long a key should be pressed. During the this period, there will be no other action.  

The longer it was set, the less roll you can get from

In some devices (e.g. Nintendo Switch). A really short button press time (below 20ms) will not be recognized.

### ```cd_length```
How many times will loop to read all 4 sensors' ```analogValue```. The smaller it was set, the faster response you will get after one hit. and it will more likely causing mistaken input.

Since ```cd_length``` define one loop for all 4 sensors, ```buffer_size``` should be ```4*cd_length```.

### ```k_increase```
Every time a hit was detective, the threshold will change to the largest pin value multiplied by ```k_increase```. Which can prevent double input when the ```cd_length```/```buffer_size``` was set too low.

### ```k_decay```
Every loop the current threshold will multiply ```k_decay``` in order to go back to the original threshold.


###

## Credit
Switch support from
[Nintendo Switch Library](https://www.arduino.cc/reference/en/libraries/nintendoswitchcontrollibrary/) by [lefmarna](https://github.com/lefmarna).  
Algorithm inspired by multiple Taiko project, including:  
 [ArduinoTaikoController](https://github.com/LuiCat/ArduinoTaikoController) by [LuiCat](https://github.com/LuiCat).  
[Taiko-Input](https://github.com/sachikoxz12/Taiko-Input) by [sachikoxz12](https://github.com/sachikoxz12).